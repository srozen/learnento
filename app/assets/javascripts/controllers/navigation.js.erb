angular.module('Learnento').controller('NavigationController', ['Authentication', '$scope', '$rootScope', 'Notification', 'ngAudio', function(Authentication, $scope, $rootScope, Notification, ngAudio){

    $scope.loggedIn = Authentication.loggedIn();
    $scope.currentUser = Authentication.currentUser();
    $scope.friendNotification = 0;
    $scope.messagingNotification = 0;

    var connectSocket = function(){
        if($scope.loggedIn){

            <% if Rails.env.production? %>
              $rootScope.socket = io.connect('http://46.101.155.249:5001');
            <% else %>
              $rootScope.socket = io.connect('http://localhost:5001');
            <% end %>

            $rootScope.socket.on('connect', function(data){
                $rootScope.socket.emit('storeUserId', {id: $scope.currentUser.id});

                Notification.activeFriendNotifications().success(function(data){
                    $scope.friendNotification = data.number;
                });

                Notification.activeMessagingNotifications().success(function(data){
                    $scope.messagingNotification = data.number;
                })
            });

            $rootScope.socket.on('friendRequest', function(data){
                $scope.$apply($scope.friendNotification++);
                <% if !Rails.env.test? %>
                  ngAudio.play('sounds/navigationNotification.mp3');
                <% end %>
            });

            $rootScope.socket.on('messaging', function(data){
              $scope.$apply($scope.messagingNotification++);
              <% if !Rails.env.test? %>
                ngAudio.play('sounds/navigationNotification.mp3');
              <% end %>
            });
        }
    };


    connectSocket();

    $scope.logout = function(){
        Authentication.logout();
    };

    $scope.clearFriendNotification = function(){
        Notification.clearFriendNotifications($scope.currentUser.id).success(function(data){
            $scope.friendNotification = data.number;
        });
    };

  $scope.clearMessagingNotification = function(){
    Notification.clearMessagingNotifications($scope.currentUser.id).success(function(data){
      $scope.messagingNotification = data.number;
    });
  };

    $rootScope.$on('logout', function(){
        $scope.loggedIn = false;
    });
    $rootScope.$on('login', function(){
        $scope.loggedIn = Authentication.loggedIn();
        $scope.currentUser = $rootScope.currentUser;
        connectSocket();
    });
}]);